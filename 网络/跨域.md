**跨域**

- 所谓跨域就是违背了浏览器的同源策略
- 跨域并不是请求发不出去，请求能发出去，服务端能收到请求并正常返回结果，只是结果被浏览器拦截了

**同源策略**

* 同源策略是一种约定，是浏览器最核心也是最基本的安全功能
* 若缺少同源策略，浏览器很容易受到XSS、CSRF等攻击
* 同源指的是：协议、域名、端口三者相同

**同源策略的限制内容**

* cookie、localStorage、indexDB等存储性内容

* DOM节点

* ajax请求发送之后，结果被浏览器拦截了

* 有三个标签允许跨域加载

  * <img src="xxx">

  * <link href="xxx">

  * <script src="xxx">

**跨域的解决方案**

- 解决方案有jsonp、cors、postMessage、websocket、Node中间件代理(两次跨域)、nginx反向代理等；CORS 支持所有类型的HTTP请求，是跨域HTTP请求的根本解决方案；JSONP只支持GET请求，JSONP的优势在于支持老式浏览器，以及可以向不支持CORS的网站请求数据；不管是Node中间件代理还是nginx反向代理，主要是通过同源策略对服务器不加限制。日常工作中，用得比较多的跨域方案 是cors和nginx反向代理

##### CORS解决跨域资源共享

- cors是在服务端进行配置，通过安装第三方cors中间件，添加http响应头
- Access-Control-Allow-Origin：允许哪些网站请求服务器
- Access-Control-Allow-Headers：声明额外的请求头
- Access-Control-Allow-Methods：声明允许的请求方式

##### 简单请求：

- 客户端与服务器间只发生一次请求
- 请求方式：get，post，head三者之一
- http头部不超过某些范围，不包含自定义字段

##### 预检请求：

- 客户端与服务器之间发生两次请求
- 在浏览器与服务器正式通信前，浏览器会先发送option请求进行预检，以获知服务器是否允许该预检请求，
- 服务器响应预检请求后，才会发送真正的请求，并且携带真实的数据
- 简单请求的对立面

##### JSONP解决跨域资源共享

- 客户端通过<script>标签的src属性，请求服务器上的数据，同时，服务器返回一个函数调用
- jsonp不属于真正的ajax请求
- jsonp仅仅支持get请求
- 为了防止冲突，必须在配置CORS中间件之前声明JSONP接口

##### 使用JSONP的步骤

* 客户端声明一个回调函数，该函数名需要作为参数传递给跨域请求数据的服务器
* 客户端把跨域的API数据接口地址，赋值给script的src，同时在该地址中向服务器传递该函数名（附加参数形式）
* 服务器收到请求之后，进行特殊的处理，把传进来的函数名和要响应的数据拼接成一个函数调用的字符串
* 服务器把数据通过http协议响应给客户端，客户端执行之前的回调对数据进行操作

**postMessage解决跨域**

* H5中的window属性（API）
* 允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文档、 多窗口、跨域消息传递
* 页面和其打开的新窗口的数据传递
* 多窗口之间的消息传递
* 页面和嵌套的iframe之间的消息传递
* 以上场景的跨域数据传递

**websocket解决跨域**

* Websocket是H5的一个持久化协议，它实现了浏览器与服务器的全双工通信，同时也是跨域的一种解决方案
* WebSocket和HTTP都是应用层协议，都基于 TCP 协议
* WebSocket 是一种双向通信协议，在建立连接之后，WebSocket 的 server 与 client 都能主动向对方发送或接收数据
* WebSocket 在建立连接时需要借助 HTTP 协议，连接建立好后 client 与 server 之间的双向通信就与 HTTP 无关了

**Node中间件代理(两次跨域)**

* 实现原理：同源策略是浏览器需要遵循的标准，而如果是服务器向服务器发请求就无需遵循同源策略。
* 代理服务器，需要做以下几个步骤：
  1. 接受客户端请求
  2. 将请求转发给服务器
  3. 拿到服务器响应数据
  4. 将响应转发给客户端

**nginx反向代理**

* 类似于Node中间件代理，需要搭建一个中转nginx服务器，用于转发请求
* 只需要修改nginx的配置即可解决跨域问题，支持所有浏览器，支持session，不需要修改任何代码，并且不会影响服务器性能
* 实现思路：通过nginx配置一个代理服务器（域名与domain1相同，端口不同）做跳板机，反向代理访问domain2接口，并且可以顺便修改cookie中domain信息，方便当前域cookie写入，实现跨域登录。