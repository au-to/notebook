这是网络面试中的高频问题之一，以下是 **TCP 三次握手、四次挥手的完整过程** 和 **为什么需要三次握手的原因**。

---

## ✅ 一、三次握手（建立连接）

三次握手的目的是：**客户端与服务器相互确认彼此的接收与发送能力，建立可靠连接。**

### 🌐 流程图：

```
客户端                                服务端
  | ----------- SYN ------------>       |   （1）
  | <-------- SYN + ACK ---------       |   （2）
  | ----------- ACK ------------>       |   （3）
  |                                     |
连接建立成功
```

### 📌 每一步说明：

1. **客户端 → 服务端：发送 SYN**

   * 客户端发送一个 `SYN` 报文（标记为 SYN=1，seq=x）
   * 表示客户端想要建立连接，进入 `SYN_SENT` 状态

2. **服务端 → 客户端：发送 SYN + ACK**

   * 服务端收到 SYN 后，回复 `SYN+ACK` 报文（SYN=1，ACK=1，seq=y，ack=x+1）
   * 表示收到请求，并同意连接，进入 `SYN_RECEIVED` 状态

3. **客户端 → 服务端：发送 ACK**

   * 客户端收到确认，发送一个 `ACK` 报文（ACK=1，ack=y+1）
   * 表示连接建立完毕，客户端进入 `ESTABLISHED` 状态
   * 服务端接收到 ACK 后也进入 `ESTABLISHED` 状态

---

## 🤔 为什么需要三次握手？

为了**防止已经失效的连接请求报文段被服务器误认为是新的连接**。

### 举个场景说明：

1. 客户端发送第一个 SYN 报文，但网络很慢，超时没响应，客户端放弃连接。
2. 这个失效的 SYN 报文延迟到达服务端，服务端此时回复 SYN+ACK 并等待客户端回应。
3. 客户端此时已不在连接状态，不会回应 ACK，但服务端会一直等待，造成资源浪费。

➡️ 所以三次握手的关键是：**客户端最后必须明确告诉服务端“我还在且想连接”，避免误连接。**

---

## ✅ 二、四次挥手（断开连接）

关闭连接比建立连接更复杂一些，因为 TCP 是**全双工通信**（双向都要关闭）。

### 🌐 流程图：

```
客户端                                服务端
  | ----------- FIN ------------>       |   （1）
  | <----------- ACK ------------       |   （2）
  |                                     |
  | <----------- FIN ------------       |   （3）
  | ----------- ACK ------------>       |   （4）
连接关闭成功
```

### 📌 每一步说明：

1. **客户端 → 服务端：发送 FIN**

   * 客户端发出断开连接请求（FIN=1），进入 `FIN_WAIT_1` 状态

2. **服务端 → 客户端：发送 ACK**

   * 服务端确认客户端的 FIN，进入 `CLOSE_WAIT` 状态
   * 客户端接收到 ACK，进入 `FIN_WAIT_2` 状态

3. **服务端 → 客户端：发送 FIN**

   * 等待服务端数据处理完后，服务端也发出 FIN，进入 `LAST_ACK`

4. **客户端 → 服务端：发送 ACK**

   * 客户端收到 FIN 后回应 ACK，进入 `TIME_WAIT`
   * 等待 2 个最大报文寿命时间（2MSL）后，进入 `CLOSED`

---

## 🤔 为什么是四次？

* 关闭连接时，**双方都需要各自独立关闭自己的发送通道**。
* 因此，一个 `FIN` 和 `ACK` 只能代表单方向的关闭，双方需要**两次 FIN + 两次 ACK**，共四次挥手。

---

## ✅ 三、面试常见追问点

| 问题                         | 简答                          |
| -------------------------- | --------------------------- |
| **TIME\_WAIT 为什么要等 2MSL？** | 确保最后的 ACK 能被对方收到；防止旧连接影响新连接 |
| **为什么连接是双向的要两次关闭？**        | TCP 是全双工，双方独立关闭自己方向的通信      |
| **三次握手可以变成两次吗？**           | 不可以，会导致服务端误连接（上面讲的失效 SYN）   |

---