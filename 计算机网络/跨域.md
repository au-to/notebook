**跨域**

- 所谓跨域就是违背了浏览器的同源策略
- 跨域并不是请求发不出去，服务端也能收到请求并正常返回响应，只是响应被浏览器拦截了

**同源策略**

* 同源策略是一种约定，是浏览器最核心也是最基本的安全功能
* 同源指的是：协议、域名、端口号三者必须相同
* 若缺少同源策略，浏览器很容易受到XSS、CSRF等攻击

**同源策略的限制内容**

* cookie、localStorage、indexDB等存储性内容

* DOM节点

* ajax请求发送之后，返回的结果被浏览器拦截

* 但有三个标签允许跨域加载

  ``` html
  <img src="xxx">
  <link href="xxx">
  <script src="xxx">
  ```

**跨域的解决方案**

- jsonp、cors跨域认证、postMessage、websocket、node中间件代理(两次跨域)、nginx反向代理等
- cors支持所有类型的HTTP请求，是跨域请求的根本解决方案；jsonp只支持get请求，优势在于支持老式浏览器，以及可以向不支持cors的网站请求数据；不管是node中间件代理还是nginx反向代理，原理都是同源策略对服务器不加限制

##### CORS

- cors是在服务端进行配置，通过安装第三方cors中间件，添加http响应头
- Access-Control-Allow-Origin：允许哪些网站请求服务器
- Access-Control-Allow-Headers：声明额外的请求头
- Access-Control-Allow-Methods：声明允许的请求方式

##### JSONP

- 客户端通过<script>标签的src属性，请求服务器上的数据，同时，服务器返回一个函数调用
- jsonp不属于真正的ajax请求
- jsonp仅仅支持get请求
- 为了防止冲突，必须在配置CORS中间件之前声明JSONP接口

##### 使用JSONP的步骤

* 客户端声明一个回调函数，该函数名需要作为参数传递给服务器
* 客户端把跨域的api接口地址，赋值给script的src，同时在该接口地址中向服务器传递该函数名（附加参数形式）
* 服务器收到请求之后，把传进来的函数名和要响应的数据拼接成一个函数调用的字符串，响应给客户端
* 客户端执行之前的回调函数对响应的数据进行操作

**postMessage**

* 允许不同源的脚本采用异步方式进行通信，实现跨文档、 跨窗口、跨域消息传递
* 页面和嵌套的iframe之间的消息传递

**websocket**

* Websocket是H5的一个持久化协议，实现了浏览器与服务器的全双工通信，同时也是跨域的一种解决方案
* WebSocket和HTTP都是应用层协议，都基于TCP协议
* WebSocket在建立连接时需要借助HTTP协议，连接建立好后，客户端与服务端之间的通信就与HTTP无关了
* WebSocket是一种全双工通信协议，建立连接后，通信双方都能主动向对方发送或接收数据

**Node中间件代理(两次跨域)**

* 原理：同源策略限制的是浏览器，服务器之间没有同源策略
* 代理服务器的职责：
  1. 接受客户端请求
  2. 将请求转发给服务器
  3. 拿到服务器响应的数据
  4. 将响应转发给客户端

**nginx反向代理**

* 类似于Node中间件代理，需要搭建一个负责中转的nginx服务器，用于转发请求
* 只需要修改nginx的配置即可解决跨域问题，支持所有浏览器，支持session，并且不会影响服务器性能
* 实现思路：通过nginx配置一个代理服务器（域名与域1相同，端口不同）做跳板机，反向代理访问域2接口，并且可以顺便修改cookie中的域信息，方便当前域cookie写入，实现跨域登录